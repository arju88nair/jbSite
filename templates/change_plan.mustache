{{> header}}

<!-- C O N T E N T -->
<div class="content_wrapper background_color_gray">
    <!--<div class="page_title_block">
        <div class="container">
            <h2 class="title">Portfolio. 4 Columns</h2>
            <div class="breadcrumbs"><a href="home.html">Home</a><a href="#">Portfolio</a><span>4 Columns</span></div>
        </div>
    </div>-->
    <style>
        .contentarea .row-fluid .module_padding {
            background-color: #347AB6;
            margin-top: 40px;
            margin-bottom: 40px;
            padding-top: 40px;
            padding-bottom: 40px;
            border-radius: 5px;

        }

        .contentarea .row-fluid .module_padding .center_div {
            margin: 0 auto;
            width: 80% /* value of your choice which suits your alignment */
        }

        .contentarea .row-fluid .module_padding .center_div h4 {
            padding-top: 0px !important;
            color: #fff;
        }

        .contentarea .row-fluid .module_padding_active {
            background-color: #EFAC54;
            margin-top: 40px;
            margin-bottom: 40px;
            padding-top: 40px;
            padding-bottom: 40px;
            border-radius: 5px;

        }

        .contentarea .row-fluid .module_padding_active .center_div {
            margin: 0 auto;
            width: 80% /* value of your choice which suits your alignment */
        }

        .contentarea .row-fluid .module_padding_active .center_div h4 {
            padding-top: 0px !important;
            color: #fff;
        }

        #border {
            margin-top: 15px;
            padding-top: 15px;
            border: 3px solid #fff !important;
        }

        #border h5 {
            color: #fff;
            font-family: Arial;
        }

        #border_bottom {
            margin-top: 15px;
            padding-top: 15px;
            border-bottom: 1px solid #b2b2b2 !important;
        }

        #border_bottom h5 {
            color: #000;
            font-family: Arial;
        }

        #border_none {
            margin-top: 15px;
            padding-top: 15px;
        }

        #border_none h5 {
            color: #000;
            font-family: Arial;
        }

        .form-horizontal label {
            text-align: left !important;
            float: left;
            color: #999999;
        }

        .form-horizontal h4 {
            font-family: 'Arial';
            text-align: left;
        }

        @import url(http://fonts.googleapis.com/css?family=Lato:400,900); /* <-- Just for the demo, Yes I like pretty fonts... */

        .square {
            float: right;
            position: relative;
            width: 35%;
            padding-bottom: 35%; /* = width for a 1:1 aspect ratio */
            margin: 3%;
            background-color: #fff;
            overflow: hidden;
            /*box-shadow: 10px -10px rgba(0,0,0,0.6);*/
            transition: 0.3s;
            border-radius: 10px;
            box-shadow: 20px -16px teal;

        }

        }
        .box-shadow:after {
            content: "";
            width: 150px;
            height: 1px;
            margin-top: 88px;
            margin-left: -75px;
            display: block;
            position: absolute;
            left: 50%;
            z-index: -1;
            -webkit-box-shadow: 0px 0px 8px 2px #000000;
            -moz-box-shadow: 0px 0px 8px 2px #000000;
            box-shadow: 0px 0px 8px 2px #000000;
        }

        .square:hover {

            /*  box-shadow: 5px -5px rgba(0,0,0,0.6); */

        }

        .title_text {

            font-size: 30px;
            line-height: 30px;
            color: #000;
            font-family: Century;
        }

        .content1 {
            position: absolute;
            height: 90%; /* = 100% - 2*5% padding */
            width: 90%; /* = 100% - 2*5% padding */
            padding: 5%;

        }

        .table {
            display: table;
            width: 100%;
            height: 100%;
        }

        .table-cell {
            display: table-cell;
            vertical-align: middle;
        }

        /*  For responsive images */

        .content1 .rs {
            width: auto;
            height: auto;
            max-height: 90%;
            max-width: 100%;
        }

        }


    </style>
    <div class="container">

        <div class="spinner"  style='display: none;z-index: 100;opacity:0.55;background-color: grey'>
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
        <div class="content_block no-sidebar row">
            <div class="fl-container span12">
                <div id="{{planname}}" class="planid"></div>

                <div class="contentarea">
                    <div class="module_line_trigger" data-option="" data-background="#323232 url(img/) no-repeat center"
                         data-top-padding="top_padding_normal">

                        <div class="row-fluid">
                            <div class="span12 module_cont module_price_table">
                                <div class="bg_title bg_title_price" style="text-align: center;">
                                    <h4 class="headInModule">YOUR PLAN DETAILS</h4>
                                </div>
                                <div class="row">
                                    <div class="span6 module_cont module_text_area module_medium_padding">
                                        <!-- 1st row verticaly centered text in the square columns -->

                                        <!--{{# plan_data}}-->

                                            <!--{{# web_signup_plan}}-->
                                                <!--<a href="/signup?planid={{plan_id}}&planname={{promo_code}}">-->
                                                    <!--<div class="square box-shadow" id="box_{{plan_id}}">-->
                                                        <!--<div class="content1">-->
                                                            <!--<div class="table">-->
                                                                <!--<div class="table-cell title_text">-->
                                                                    <!--{{promo_code}}-->
                                                                <!--</div>-->
                                                            <!--</div>-->
                                                        <!--</div>-->
                                                    <!--</div>-->
                                                <!--</a>-->
                                            <!--{{/web_signup_plan}}-->
                                        <!--{{/plan_data}}-->
                                        <style>
                                            h3{
                                                color:white;

                                            }
                                            .card{
                                                margin: 5px;
                                                box-shadow: 1px 0px 4px 2px grey;

                                            }


                                            .card-active{

                                                padding-top: 20px;
                                                padding-bottom: 6px;

                                                margin-bottom: 15px;
                                                box-shadow: 1px 0px 4px 2px grey;
                                            }
                                            .PLATINUM{
                                                background-color: #EDAB53;
                                            } .STARTER{
                                                  background-color: #3379B4;
                                              } .DEFAULT{
                                                    background-color: #58B75B;
                                                }
                                        </style>

                                        {{# plan_data}}
                                            <a href="/signup?planname={{PROMO}}&books={{NO_OF_BOOKS}}&months={{NO_OF_MONTHS}}"><div class="col-md-7 col-md-offset-2"><div class="card {{PLAN_NAME}}" id="box_{{PLAN_NAME}}"  ><h3 class="htag_{{PLAN_NAME}}">{{PLAN_NAME}}</h3></div></div></a>
                                        {{/plan_data}}








                                    </div>
                                    <div class="span6 r_content">
                                        <div class="col-sm-11">
                                            <div class="col-sm-6">
                                                <select class="form-control" id="books">
                                                    <option value="">Select No of Books:</option>
                                                    {{# plan_books}}
                                                        <option value="{{.}}">{{.}} books(s)</option>
                                                    {{/plan_books}}
                                                </select></br>
                                            </div>
                                            <div class="col-sm-6">
                                                <select class="form-control" id="months">
                                                    <option value="">Select No of Months:</option>

                                                </select></br>
                                            </div>
                                        </div>

                                        <div class="col-sm-11" id="border_bottom">
                                            <div class="col-sm-6">
                                                <h5 style="float: left">One Time Registration Fee:</h5>
                                            </div>
                                            <div class="col-sm-4" id="reg_fee">
                                                <h5></h5>
                                            </div>
                                        </div>
                                        <div class="col-sm-11" id="border_bottom">
                                            <div class="col-sm-6">
                                                <h5 style="float: left"> Security Deposit:</h5>
                                            </div>
                                            <div class="col-sm-4" id="sec_deposit_fee">
                                                <h5></h5>
                                            </div>
                                        </div>
                                        <div class="col-sm-11" id="border_bottom">
                                            <div class="col-sm-6">
                                                <h5 style="float: left">Reading Fee:</h5>
                                            </div>
                                            <div class="col-sm-4" id="reading_fee">
                                                <h5></h5>
                                            </div>
                                        </div>
                                        <div class="col-sm-11" id="border_none">
                                            <div class="col-sm-6">
                                                <h5 style="float: left">Total:</h5>
                                            </div>
                                            <div class="col-sm-4" id="total_fee">
                                                <h5></h5>
                                            </div>
                                        </div>
                                        <div class="col-sm-11">
                                            <!--<div class="col-sm-offset-2 col-sm-8">-->
                                                <!--<a href="#anchor2" class="btn btn-success btn-block" id="plan_submit"-->
                                                   <!-->Change Plan</a>-->
                                            <!--</div>-->
                                        </div>
                                    </div>
                                </div>

                            </div><!-- .module_cont -->
                        </div><!-- .row-fluid -->
                    </div>
                </div>
                <div class="row" style="background-color:#fff; margin-top:20px; margin-bottom:20px; border-radius:5px;">
                <a id="anchor2"></a>
                <div class="span12 module_cont module_text_area"></br>
                <form class="form-horizontal" id="signup_form">

                <h4 class="dark-grey">Coupon Information</h4>

                <div class="col-md-6">
                <div class="form-group">
                <div class="col-sm-5">
                <label>Apply Referral code, if any:</label>
                <input type="text" class="form-control" id="referral code"
                placeholder="Member Card No." name="referral_code">
                </div>
                <div class="col-sm-5">
                <label>Apply coupon code, if any:</label>
                <input type="text" class="form-control" id="coupon_code"
                placeholder="Coupon Code" name="coupon_code">
                </div>
                <div class="col-sm-2" style="padding-top:22px;">
                <button type="submit" class="btn btn-warning" id="coupon_submit">Apply</button>
                </div>
                </div>
                </div>

                <div class="col-md-6">
                <div class="form-group">
                <div class="col-sm-5">
                <label>Apply gift card, if any:</label>
                <input type="text" class="form-control" id="gift_card"
                placeholder="Gift Card No." name="gift_card">
                </div>
                <div class="col-sm-5" style="padding-top:22px;">
                <input type="text" class="form-control" id="gift_card_pin" placeholder="PIN"
                name="gift_card_pin">
                </div>
                <div class="col-sm-2" style="padding-top:22px;">
                <button type="submit" class="btn btn-warning" id="gift_card_submit">Apply
                </button>
                </div>
                </div>
                <div class="form-group">

                </div>
                <div class="form-group">

                </div>
                </div>
                <!----------/////////////////////END/////////////////////////-------------------->

                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="col-sm-6">
                                <button type="button"  onclick="changePlan()" class="btn btn-success btn-block" id="signup" >Change Plan
                                </button>
                            </div>
                        </div>
                    </div>


                </form>
                </div>
                <!--</div>-->
            </div>
        </div><!-- .contentarea -->
    </div>
</div>
<div class="clear"><!-- ClearFix --></div>

<div class="clear"><!-- ClearFix --></div>
<script type="application/javascript">
    $(document).ready(function()
    {
        var planid = $('.planid').attr('id');

        $('#box_' + planid).css({
            'padding-top': '20px',
            'padding-bottom' : '6px',
            'border-radius': '8px',
            'margin-bottom': '15px',
            'box-shadow': '1px 4px 4px 2px grey'
        });

        $('#plansHeader').addClass('current-menu-parent');

    })
    function passwordval() {

        if ($("#Cpassword").val() !== $("#password").val()) {
            $("#error").text("Passwords doesnot match!");
            $("#error").show();
            return false;
        }
        else {
            $("#error").hide();
        }
    }

    var reg_fee;
    var secDeposit;
    $(document).ready(function () {


        var planname = "{{planname}}";
        var planid = "{{planid}}";


        var planid = $('.planid').attr('id');


//        $.ajax({
//            type: "GET",
//            url: "http://staging.justbooksclc.com:8990/api/v1/get_plan_detail.json?plan_id=" + planid,
//            success: function (data_new) {
//                reg_fee = data_new['result']['web_signup_plan']['registration_fee'];
//                secDeposit = data_new['result']['web_signup_plan']['security_deposit']
//                for (var i = 0; i < data_new['result']['web_signup_plan']['plan_durations'].length; i++) {
//
//                    $("#months").append('<option value="' + data_new['result']['web_signup_plan']['plan_durations'][i]['plan_duration']['reading_fee_for_term'] + '">' + data_new['result']['web_signup_plan']['plan_durations'][i]['plan_duration']['signup_months_keyword'] + '</option>')
//                    console.log(data_new['result']['web_signup_plan']['plan_durations'][i]['plan_duration']['signup_months_keyword'])
//                }
//
//            },
//
//        });


        $("#dob").datepicker({
            dateFormat: 'dd-mm-yy',
            changeMonth: true
        }).val();
    });

    var planid = $('.planid').attr('id');
    var mon = '';
    var book = '';
    $('#box_' + planid).attr('style', 'background-color:#FF6861');
    $('#months').on('change', function () {
        mon = this.value;
        $(".spinner").show();

        book = $("#books").val();

        updateFees();
    });
    $('#books').on('change', function () {
        $("#months").empty();
        $("#months").hide();
        $(".spinner").show();
        $("#months").empty();
        book = this.value;
        $.ajax({
            type: "GET",
            url: "/getPlanYears?book=" + book + "&planname=" + "{{planname}}",
            success: function (data_new) {
                $(".spinner").hide();

                console.log(data_new);
                console.log(JSON.parse(data_new));
                data_new = JSON.parse(data_new);
                if (data_new['status'] === "2nd") {
                    data_new = data_new['data'];
                    console.log(data_new)

                    if (data_new.length != 0 || data_new != [] || data_new != '[]') {
//                        $('.planid').attr(data_new['planID']);
                        for (var i = 0; i < data_new.length; i++) {

                            $("#months").append('<option value="' + data_new[i] + '">' + data_new[i] + ' months(s)</option>')

                        }
                        $("#months").prepend("<option value=''>Select months</option>").val('');

                        $("#months").show();
                    }
                }
                else {
//                    $('.planid').attr(data_new['planID']);
                    $("#months").show();

                    $("#months").append('<option value="' + data_new['month'] + '">' + data_new['month'] + ' month(s)</option>')
                    $('#reg_fee h5').html("₹ "+data_new['reg_fee']);
                    $('#sec_deposit_fee h5').html("₹ "+data_new['sec_deposit']);
                    $('#reading_fee h5').html("₹ "+data_new['reading_fee']);
                    $('#total_fee h5').html("₹ "+data_new['total']);

                }


            },
            error: function (err) {
                console.log(err.responseText)
            }

        });


        //        updateFees();
    });
    function updateFees() {
        console.log(planid + "assas" + mon + "aasass" + book);
        if (mon != '' && book != '') {
            $.ajax({
                type: "GET",
                url: "/getPlanFees?book=" + book + "&months=" + mon + "&planname=" + "{{planname}}",
                success: function (data_new) {
                    $(".spinner").hide();

                    console.log(data_new);
                    data_new = JSON.parse(data_new);
                    console.log(data_new);
//                        console.log(data_new['reg_fee']);
                    $('#reg_fee h5').html("₹ "+data_new['reg_fee']);
                    $('#sec_deposit_fee h5').html("₹ "+data_new['sec_deposit']);
                    $('#reading_fee h5').html("₹ "+data_new['reading_fee']);
                    $('#total_fee h5').html("₹ "+data_new['total']);
                },
                error: function (err) {
                    $(".spinner").hide();

                    console.log(err.responseText)
                }

            });
        }
    }


    $.ajax({
        type: "GET",
        url: "/getCitiesAndState",
        success: function (data_new) {
            data_new = JSON.parse(data_new);
            console.log(data_new);
            console.log(data_new[0]['city']);
            data_new[0]['city'].forEach(function (arr) {
                $('#city').append("<option value=" + arr['CITYID'] + ">" + arr['CITYNAME'] + "</option>");
            });
            data_new[0]['state'].forEach(function (arr) {
                $('#state').append("<option value=" + arr['STATEID'] + ">" + arr['STATENAME'] + "</option>");
            });
        },

    });


    $('#coupon_submit').click(function (e) {
        $(".spinner").show();
        e.preventDefault();
        var coupon = $('#coupon_code').val();
        $.ajax({
            type: "POST",
            url: "/couponValidate",
            data: {'coupon': coupon, 'planid': planid, 'months': mon},
            success: function (data_new) {
                $(".spinner").hide();
                data_new = JSON.parse(data_new);
                console.log(data_new);
                if (data_new['success'] == true) {
                    toastr.success('Gift card added !');
                }
                else {

                    $("#error").text(data_new['errors']);
                    $("#error").show();

                }


            },

        });
    });

    $('#gift_card_submit').click(function (e) {
        $(".spinner").show();
        e.preventDefault();
        var gift_card = $('#gift_card').val();
        var gift_card_pin = $('#gift_card_pin').val();
        var total_amnt = $('#total_fee h5').html();
        $.ajax({
            type: "POST",
            url: "/giftcardValidate",
            data: {'gift_card': gift_card, 'gift_card_pin': gift_card_pin, 'total_amnt': total_amnt},
            success: function (data_new) {
                $(".spinner").hide();
                data_new = JSON.parse(data_new);
                console.log(data_new);
                if (data_new['success'] == true) {
                    toastr.success('Gift card added !');
                }
                else {

                    $("#error").text(data_new['errors']);
                    $("#error").show();

                }

            },

        });
    });


    function planFees() {
        var readingFee = $("#months").val();
        $('#reg_fee h5').html(reg_fee);
        $('#sec_deposit_fee h5').html(secDeposit);
        $('#reading_fee h5').html(readingFee);
        $('#total_fee h5').html(parseFloat(reg_fee) + parseFloat(secDeposit) + parseFloat(readingFee));
    }


    function changePlan() {
        $(".spinner").show();
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-93821751-1', 'none');
        ga('send', 'event', 'Clicks', 'Change Plan', 'First Screen');
        var planid = $('.planid').attr('id');
        var email=localStorage.getItem("email");
        ga('send', 'event', 'Clicks', 'Change plan of user '+email+'', 'First Screen');
        var terms=$("#months").val();
        var coupon=$("#coupon_code").val();
        var gift=$("#gift_card").val();
        if(coupon == "")
        {
            coupon="null";
        }

        if(gift == "")
        {
            gift="null";
        }
        if(terms == null ||terms == "")
        {
           toastr.error("Please select a plan duration") ;
            $(".spinner").hide();
            return false;
        }

        var membership=localStorage.getItem("membership");

        $.ajax({
            type: "GET",
            url: "http://staging.justbooksclc.com:8990/api/v1/change_plan_payment.json?email="+email+"&membercard="+membership+"&term="+terms+"&new_plan_id="+planid+"&coupon_code="+coupon+"&gift_card_no="+gift+"&pin=null",
            crossDomain:true,
            success: function (data_new) {
                console.log(data_new);
                console.log(data_new.success);

                if (data_new.success == true) {

//                    paymentConfirm();


                    var planid = $('.planid').attr('id');
                    var email=localStorage.getItem("email");
                    var terms=$("#months").val();
                    var membership=localStorage.getItem("membership");

                    $.ajax({
                        type: "GET",
                        crossDomain:true,
                        url: "http://staging.justbooksclc.com:8990/api/v1/confirm_change_plan.json?email="+email+"&membercard="+membership+"&member_id="+data_new.result.member_id+"&membership_no="+data_new.result.membership_no+"&amount="+data_new.result.amount+"&old_plan_id="+data_new.result.old_plan_id+"&new_plan_id="+data_new.result.new_plan_id+"&term="+data_new.result.term+"&created_in="+data_new.result.created_in+"&member_branch_id="+data_new.result.member_branch_id+"&old_expiry_date="+data_new.result.member_branch_id+"&new_expiry_date="+data_new.result.new_expiry_date+"&old_security_deposit="+data_new.result.old_security_deposit+"&new_security_deposit="+data_new.result.new_security_deposit+"&old_reading_fee_balance="+data_new.result.old_reading_fee_balance+"&convenience_fee="+data_new.result.convenience_fee+"&delivery_fees="+data_new.result.delivery_fees+"&delivery_option="+data_new.result.delivery_option+"&overdue_adjustment="+data_new.result.overdue_adjustment+"&adjustment_narration="+data_new.result.adjustment_narration+"&reward_points="+data_new.result.reward_points+"&coupon_no="+data_new.result.coupon_no+"&coupon_id="+data_new.result.coupon_id+"&coupon_amount="+data_new.result.coupon_amount+"&change_plan_payment_type="+data_new.result.change_plan_payment_type+"",
                        success: function (data_new) {
                            console.log(data_new+" 2nd");
                            console.log(data_new.result.transaction.transaction.order_number);
                            console.log(data_new.result.transaction);

                            if (data_new.success == true) {

                                var orderNumber = data_new.result.transaction.transaction.order_number;
                                var amount = data_new.result.transaction.transaction.amount;
                            amount=Math.abs(parseFloat(amount))
                                saveSession(orderNumber,amount);
                            }


                        },

                    });



                }


            },

        });


    }


    function paymentConfirm() {
        var planid = $('.planid').attr('id');
        var email=localStorage.getItem("email");
        var terms=$("#months").val();
        var membership=localStorage.getItem("membership");

        $.ajax({
            type: "GET",
            url: "http://staging.justbooksclc.com:8990/api/v1/confirm_change_plan.json?email="+email+"&membercard="+membership+"&member_id=40021804&membership_no=M103604&amount=1440.0&old_plan_id=400328&new_plan_id=400082&term=1&created_in=810&member_branch_id=1008&old_expiry_date=2018-05-06&new_expiry_date=null&old_security_deposit=1000&new_security_deposit=0.0&old_reading_fee_balance=3600&convenience_fee=0&delivery_fees=0&delivery_option=0&overdue_adjustment=0&adjustment_narration=null&reward_points=null&coupon_no=null&coupon_id=null&coupon_amount=null&change_plan_payment_type=card",
            success: function (data_new) {
                console.log(data_new);
                console.log(data_new.result.transaction.transaction.order_number);
                console.log(data_new.result.transaction);

                if (data_new.success == true) {

                    var orderNumber = data_new.result.transaction.transaction.order_number;
                    var amount = data_new.result.transaction.transaction.amount;

                    saveSession(orderNumber,amount);
                }


            },

        });

    }

    function saveSession(order,amount)
    {
        $.ajax({
            type: "GET",
            url: "/saveSession?orderNumber="+order+"&amount="+amount,
            success: function (data_new) {
                console.log(data_new);
                if(data_new === "success")
                {
                    window.location.href="/PaytmKit/pgRedirect.php";
                    return false;
                }

                window.location.href="/PaytmKit/pgRedirect.php"


            },

        });
    }

</script>
{{> footer}}