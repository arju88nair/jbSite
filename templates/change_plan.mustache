{{> header}}

<!-- C O N T E N T -->
<div class="content_wrapper" style="margin-top: 10%">
    <div class="page_title_block">
        <div class="container">
            <div class="bg_title" id="bg_title_shelf"><h4 class="headInModule">PLAN DETAILS </h4></div>

        </div>
    </div>

    <div class="container">
        <div class="spinner" style='display: none;z-index: 100;opacity:0.55;background-color: grey'>
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
        <div class="content_block no-sidebar row">
            <div class="fl-container span12">
                <div id="{{planname}}" class="planid"></div>
                <div id="{{planid}}" class="planID"></div>

                <div class="contentarea">
                    <div class="module_line_trigger" data-option="" data-background="#323232 url(img/) no-repeat center"
                         data-top-padding="top_padding_normal">

                        <div class="row-fluid">
                            <div class="span12 module_cont module_price_table">
                                <div class="bg_title bg_title_price" style="text-align: center;">
                                    <!-- <h4 class="headInModule">PLAN DETAILS</h4> -->
                                </div>
                                <div class="row">
                                    <div class="span6 module_cont module_text_area module_medium_padding">
                                        <!-- 1st row verticaly centered text in the square columns -->





                                            <a href="/signup?planname={{plan_data}}&books={{book}}&months={{month}}">

                                                <div class="span9 l_content">
                                                    <div class="row">
                                                        <div class='col-md-10 col-md-offset-2 card bordered'
                                                             id="box_{{plan_data}}"
                                                             style="padding-top: 7%;padding-bottom: 4%;text-indent: 8%">
                                                            <div class="col-md-12 text-left">
                                                                <div class="row bottom">
                                                                    <div class="col-md-12 left">
                                                                        <h4>{{plan_data}}</h4>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-12 text-left">
                                                                <div class="row bottom">

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>

                                        <!---->


                                        <!--<div class="col-md-7"><div class="card" style="background-color: #EDAB53;" ><h3>hwhwhwh</h3></div></div>-->
                                        <!--<div class="col-md-7"><div class="card" style="background-color: #3379B4;"><h3>hwhwhwh</h3></div></div>-->
                                        <!--<div class="col-md-7"><div class="card" style="background-color: #58B75B;"><h3>hwhwhwh</h3></div></div>-->

                                    </div>
                                    <a id="signup"></a>
                                    <div class="span6 r_content">
                                        <div class="col-sm-11">
                                            <div class="col-sm-6">
                                                <select class="form-control" id="books">
                                                    <option value="">Select No of Books:</option>
                                                    {{# plan_books}}
                                                        <option value="{{.}}">{{.}}  book(s)</option>
                                                    {{/plan_books}}
                                                </select></br>
                                            </div>
                                            <div class="col-sm-6">
                                                <select class="form-control" id="months">
                                                    <option value="">Select No of Months:</option>
                                                    {{# months}}
                                                        <option value="{{.}}">{{.}}  month(s)</option>
                                                    {{/months}}
                                                </select></br>
                                            </div>
                                        </div>

                                        <div class="col-sm-11" id="border_bottom">
                                            <div class="col-sm-11" id="border_bottom">
                                                <div class="col-sm-6">
                                                    <h5 style="float: left">Available Balance:</h5>
                                                </div>
                                                <div class="col-sm-4" id="reg_fee">
                                                    <h5>₹ {{available_balance}}</h5>
                                                </div>
                                            </div>
                                            <div class="col-sm-11" id="border_bottom">
                                                <div class="col-sm-6">
                                                    <h5 style="float: left"> Balance Due:</h5>
                                                </div>
                                                <div class="col-sm-4" id="sec_deposit_fee">
                                                    <h5>₹ {{balance_due}}</h5>
                                                </div>
                                            </div>
                                            <div class="col-sm-11" id="border_bottom">
                                                <div class="col-sm-6">
                                                    <h5 style="float: left">Reading Fee:</h5>
                                                </div>
                                                <div class="col-sm-4" id="reading_fee">
                                                    <h5>₹ {{reading_fee}}</h5>
                                                </div>
                                            </div>
                                            <div class="col-sm-11" id="border_none">
                                                <div class="col-sm-6" style="" id="totalDiv">
                                                    <h5 style="float: left">Total Payable Amount:</h5>
                                                </div>
                                                <div class="col-sm-4" id="total_fee">
                                                    <h5>₹ {{totalAMount}}</h5>
                                                </div>
                                            </div>
                                        </div>

                                    </div><!-- .module_cont -->
                                </div><!-- .row-fluid -->
                            </div>
                        </div>
                        <div class="row"
                             style="background-color:#fff; margin-top:20px; margin-bottom:20px; border-radius:5px;">
                            <a id="anchor2"></a>
                            <div class="span12 module_cont module_text_area"></br>
                                <form class="form-horizontal" id="signup_form">

                                    <h4 class="dark-grey">Coupon Information</h4>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <div class="col-sm-5">
                                                <label>Apply Referral code, if any:</label>
                                                <input type="text" class="form-control" id="referral code"
                                                       placeholder="Member Card No." name="referral_code">
                                            </div>
                                            <div class="col-sm-5">
                                                <label>Apply coupon code, if any:</label>
                                                <input type="text" class="form-control" id="coupon_code"
                                                       placeholder="Coupon Code" name="coupon_code">
                                            </div>
                                            <div class="col-sm-2" style="padding-top:22px;">
                                                <button type="submit" class="btn shortcode_button btn_small btn_type1" id="coupon_submit">Apply
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <div class="col-sm-5">
                                                <label>Apply gift card, if any:</label>
                                                <input type="text" class="form-control" id="gift_card"
                                                       placeholder="Gift Card No." name="gift_card">
                                            </div>
                                            <div class="col-sm-5" style="padding-top:22px;">
                                                <input type="text" class="form-control" id="gift_card_pin"
                                                       placeholder="PIN"
                                                       name="gift_card_pin">
                                            </div>
                                            <div class="col-sm-2" style="padding-top:22px;">
                                                <button type="submit" class="btn shortcode_button btn_small btn_type1" id="gift_card_submit">
                                                    Apply
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-group">

                                        </div>
                                        <div class="form-group">

                                        </div>
                                    </div>
                                    <!----------/////////////////////END/////////////////////////-------------------->

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <div class="col-sm-6">
                                                <button type="button" onclick="changePlan()"
                                                        class="btn shortcode_button btn_medium btn_type1"
                                                        id="signup">Change Plan
                                                </button>
                                            </div>
                                        </div>
                                    </div>


                                </form>
                            </div>
                            <!--</div>-->
                        </div>
                    </div>
                </div>
            </div><!-- .contentarea -->
            </div>
        </div>
        <div class="clear"><!-- ClearFix --></div>

        <div class="clear"><!-- ClearFix --></div>
        <script type="application/javascript">

            $(document).ready(function () {
//            var texts=$(".htag_starter").text().toUpperCase();
//    console.log(texts);
//        $(".htag_starter").text(texts);
//        $(".hTag").text($(".hTag").text().toUpperCase());

                $("#books").val("{{book}}");
                $("#months ").val("{{month}}");


                $('#plansHeader').addClass('current-menu-parent');

            });


            function passwordval() {

                if ($("#Cpassword").val() !== $("#password").val()) {
                    $("#error").text("Passwords does not match!");
                    $("#error").show();
                    return false;
                }
                else {
                    $("#error").hide();
                }
            }

            var reg_fee;
            var secDeposit;
            $(document).ready(function () {

                $('header nav ul.menu > li #plans').addClass('current-menu-parent');


                $('#checkbox').click(function () {
                    $("#signup").attr("disabled", !this.checked);
                });
                var planname = "{{planname}}";
                var planid = "{{planid}}";


                var planid = $('.planid').attr('id');

                $("#dob").datepicker({
                    dateFormat: 'dd-mm-yy',
                    changeMonth: true,
                    changeYear: true,
                    yearRange: "-100:+0"
                }).val();
            });

            var planid = $('.planid').attr('id');
            var mon = '';
            var book = '';
            $('#box_' + planid).css({

                'display': 'block',
                'background-color': '#fff',
                'box-shadow': ' 1px 1px 5px #999',
                'cursor': 'pointer',
                'border-bottom': '4px solid red'

            });
            $('#months').on('change', function () {
                $(".spinner").show();
                mon = this.value;
                book = $("#books").val();

                updateFees();
            });
            $('#books').on('change', function () {
                $("#months").hide();
                $(".spinner").show();
                $("#months").empty();
                book = this.value;
                $.ajax({
                    type: "GET",
                    url: "/getChangePlanYears?book=" + book + "&planname=" + "{{planname}}",
                    success: function (data_new) {
                        $(".spinner").hide();
                        $("#months").show();
                        console.log(data_new);
                        console.log(JSON.parse(data_new));
                        data_new = JSON.parse(data_new);
                        $(".planID").attr("id",data_new['planID'])

                        if (data_new['status'] === "2nd") {
                            data_new = data_new['data'];

                            if (data_new.length != 0 || data_new != [] || data_new != '[]') {
                                for (var i = 0; i < data_new.length; i++) {

                                    $("#months").append('<option value="' + data_new[i] + '">' + data_new[i] + '  month(s)</option>')

                                }
                                $("#months").prepend("<option value=''>Select months</option>").val('');

                            }
                        }
                        else {
                            $(".planID").attr("id",data_new['planID'])

                            $("#months").append('<option value="' + data_new['month'] + '">' + data_new['month'] + ' month(s)</option>')

                            $('#reg_fee h5').html("₹ " + data_new['available_balance']);
                            $('#sec_deposit_fee h5').html("₹ " + data_new['balance_due']);
                            $('#reading_fee h5').html("₹ " + data_new['reading_fee']);
                            $('#total_fee h5').html("₹ " + data_new['total']);

                        }


                    },
                    error: function (err) {
                        $(".spinner").hide();

                        console.log(err.responseText)
                    }

                });


                //        updateFees();
            });
            function updateFees() {
                if (mon != '' && book != '') {
                    $.ajax({
                        type: "GET",
                        url: "/getChangePlanFees?book=" + book + "&months=" + mon + "&planname=" + "{{planname}}",
                        success: function (data_new) {
                            $(".spinner").hide();
                            console.log(data_new);
                            data_new = JSON.parse(data_new);
                            console.log(data_new);
//                        console.log(data_new['reg_fee']);
                            $('#reg_fee h5').html("₹ " + data_new['available_balance']);
                            $('#sec_deposit_fee h5').html("₹ " + data_new['balance_due']);
                            $('#reading_fee h5').html("₹ " + data_new['reading_fee']);
                            $('#total_fee h5').html("₹ " + data_new['total']);
                        },
                        error: function (err) {
                            $(".spinner").hide();
                            console.log(err.responseText)
                        }

                    });
                }
            }


            $.ajax({
                type: "GET",
                url: "/getCitiesAndState",
                success: function (data_new) {
                    data_new = JSON.parse(data_new);
                    console.log(data_new);
                    console.log(data_new[0]['city']);
                    data_new[0]['city'].forEach(function (arr) {
                        $('#city').append("<option value=" + arr['CITYID'] + ">" + arr['CITYNAME'] + "</option>");
                    });
                    data_new[0]['state'].forEach(function (arr) {
                        $('#state').append("<option value=" + arr['STATEID'] + ">" + arr['STATENAME'] + "</option>");
                    });
                },

            });


            $('#coupon_submit').click(function (e) {
                $(".spinner").show();
                var planId ={{planid}};
                mon = $("#months").val();
                e.preventDefault();
                var coupon = $('#coupon_code').val();
                $.ajax({
                    type: "POST",
                    url: "/couponValidate",
                    data: {'coupon': coupon, 'planid': planId, 'months': mon},
                    success: function (data_new) {
                        $(".spinner").hide();
                        data_new = JSON.parse(data_new);
                        console.log(data_new);
                        if (data_new['success'] == true) {
                            toastr.success('Coupon accepted !');
                        }
                        else {
                            toastr.error(data_new['errors']);


                        }


                    },

                });
            });

            $('#gift_card_submit').click(function (e) {
                $(".spinner").show();
                e.preventDefault();
                var gift_card = $('#gift_card').val();
                var gift_card_pin = $('#gift_card_pin').val();
                var total_amnt = $('#total_fee h5').html();
                $.ajax({
                    type: "POST",
                    url: "/giftcardValidate",
                    data: {'gift_card': gift_card, 'gift_card_pin': gift_card_pin, 'total_amnt': total_amnt},
                    success: function (data_new) {
                        $(".spinner").hide()
                        data_new = JSON.parse(data_new);
                        console.log(data_new);
                        if (data_new['success'] == true) {
                            toastr.success(data_new['result']['error']);
                        }
                        else {

                            toastr.error(data_new['errors']);


                        }

                    },

                });
            });


            function planFees() {
                var readingFee = $("#months").val();
                $('#reg_fee h5').html(reg_fee);
                $('#sec_deposit_fee h5').html(secDeposit);
                $('#reading_fee h5').html(readingFee);
                $('#total_fee h5').html(parseFloat(reg_fee) + parseFloat(secDeposit) + parseFloat(readingFee));
            }
            function changePlan() {
                $(".spinner").show();
                (function (i, s, o, g, r, a, m) {
                    i['GoogleAnalyticsObject'] = r;
                    i[r] = i[r] || function () {
                                (i[r].q = i[r].q || []).push(arguments)
                            }, i[r].l = 1 * new Date();
                    a = s.createElement(o),
                            m = s.getElementsByTagName(o)[0];
                    a.async = 1;
                    a.src = g;
                    m.parentNode.insertBefore(a, m)
                })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

                ga('create', 'UA-93821751-1', 'none');
                ga('send', 'event', 'Clicks', 'Change Plan', 'First Screen');
                var planid = $('.planid').attr('id');
                var email = localStorage.getItem("email");
                ga('send', 'event', 'Clicks', 'Change plan of user ' + email + '', 'First Screen');
                var terms = $("#months").val();
                var coupon = $("#coupon_code").val();
                var gift = $("#gift_card").val();
                if (coupon == "") {
                    coupon = "null";
                }

                if (gift == "") {
                    gift = "null";
                }
                if (terms == null || terms == "") {
                    toastr.error("Please select a plan duration");
                    $(".spinner").hide();
                    return false;
                }

                var membership = localStorage.getItem("membership");
                var signupID = parseInt($('.planID').attr('id'));

                $.ajax({
                    type: "GET",
                    url: "/change_plan_payment?term=" + terms + "&new_plan_id=" + signupID + "&coupon_code=" + coupon + "&gift_card_no=" + gift + "",
                    crossDomain: true,
                    success: function (data_new) {
                        console.log(data_new);
                        data_new=JSON.parse(data_new);

                        if (data_new.success == true) {

//                    paymentConfirm();


                            var planid = $('.planid').attr('id');
                            var email = localStorage.getItem("email");
                            var terms = $("#months").val();
                            var membership = localStorage.getItem("membership");

                            $.ajax({
                                type: "GET",
                                crossDomain: true,
                                url: "/confirm_change_plan?member_id=" + data_new.result.member_id + "&membership_no=" + data_new.result.membership_no + "&amount=" + data_new.result.amount + "&old_plan_id=" + data_new.result.old_plan_id + "&new_plan_id=" + data_new.result.new_plan_id + "&term=" + data_new.result.term + "&created_in=" + data_new.result.created_in + "&member_branch_id=" + data_new.result.member_branch_id + "&old_expiry_date=" + data_new.result.member_branch_id + "&new_expiry_date=" + data_new.result.new_expiry_date + "&old_security_deposit=" + data_new.result.old_security_deposit + "&new_security_deposit=" + data_new.result.new_security_deposit + "&old_reading_fee_balance=" + data_new.result.old_reading_fee_balance + "&convenience_fee=" + data_new.result.convenience_fee + "&delivery_fees=" + data_new.result.delivery_fees + "&delivery_option=" + data_new.result.delivery_option + "&overdue_adjustment=" + data_new.result.overdue_adjustment + "&adjustment_narration=" + data_new.result.adjustment_narration + "&reward_points=" + data_new.result.reward_points + "&coupon_no=" + data_new.result.coupon_no + "&coupon_id=" + data_new.result.coupon_id + "&coupon_amount=" + data_new.result.coupon_amount + "&change_plan_payment_type=" + data_new.result.change_plan_payment_type + "",
                                success: function (data_new) {
                                    data_new=JSON.parse(data_new)
                                    console.log(data_new + " 2nd");
                                    console.log(data_new.result.transaction.transaction.order_number);
                                    console.log(data_new.result.transaction);

                                    if (data_new.success == true) {

                                        var orderNumber = data_new.result.transaction.transaction.order_number;
                                        var amount = data_new.result.transaction.transaction.amount;
                                        amount = Math.abs(parseFloat(amount))
                                        saveSession(orderNumber, amount);
                                    }


                                },

                            });


                        }


                    },

                });


            }


            function paymentConfirm() {
                var planid = $('.planid').attr('id');
                var email = localStorage.getItem("email");
                var terms = $("#months").val();
                var membership = localStorage.getItem("membership");

                $.ajax({
                    type: "GET",
                    url: "http://justbooksclc.com/api/v1/confirm_change_plan.json?email=" + email + "&membercard=" + membership + "&member_id=40021804&membership_no=M103604&amount=1440.0&old_plan_id=400328&new_plan_id=400082&term=1&created_in=810&member_branch_id=1008&old_expiry_date=2018-05-06&new_expiry_date=null&old_security_deposit=1000&new_security_deposit=0.0&old_reading_fee_balance=3600&convenience_fee=0&delivery_fees=0&delivery_option=0&overdue_adjustment=0&adjustment_narration=null&reward_points=null&coupon_no=null&coupon_id=null&coupon_amount=null&change_plan_payment_type=card",
                    success: function (data_new) {
                        console.log(data_new);
                        console.log(data_new.result.transaction.transaction.order_number);
                        console.log(data_new.result.transaction);

                        if (data_new.success == true) {

                            var orderNumber = data_new.result.transaction.transaction.order_number;
                            var amount = data_new.result.transaction.transaction.amount;

                            saveSession(orderNumber, amount);
                        }


                    },

                });

            }

            function saveSession(order, amount) {
                $.ajax({
                    type: "GET",
                    url: "/saveSession?orderNumber=" + order + "&amount=" + amount,
                    success: function (data_new) {
                        console.log(data_new);
                        if (data_new === "success") {
                            window.location.href = "/PaytmKit/pgRedirect.php";
                            return false;
                        }

                        window.location.href = "/PaytmKit/pgRedirect.php"


                    },

                });
            }
        </script>
{{> footer}}